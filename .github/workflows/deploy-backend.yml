name: Deploy Backend to Azure Web App (Linux) for Containers

on:
  workflow_dispatch:  # Kun manuell trigger - unng√•r dobbel deployment

permissions:
  id-token: write
  contents: read

env:
  AZURE_WEBAPP_NAME: web-teknotassen
  AZURE_RESOURCE_GROUP: teknotassen-rg
  AZURE_CONTAINER_REGISTRY: acrteknotassen
  IMAGE_NAME: teknotassen-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Login to Azure (OIDC)
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Create ACR if it doesn't exist
      - name: Create ACR if not exists
        run: |
          echo "Checking if ACR exists..."
          if ! az acr show --name $AZURE_CONTAINER_REGISTRY --resource-group $AZURE_RESOURCE_GROUP >/dev/null 2>&1; then
            echo "ACR does not exist, creating..."
            az acr create \
              --resource-group $AZURE_RESOURCE_GROUP \
              --name $AZURE_CONTAINER_REGISTRY \
              --sku Basic \
              --location norwayeast
            echo "‚úÖ ACR created successfully!"
          else
            echo "‚úÖ ACR already exists!"
          fi

      # Enable admin user on ACR (required for credentials)
      - name: Enable ACR admin user
        run: |
          echo "Enabling admin user on ACR..."
          az acr update --name $AZURE_CONTAINER_REGISTRY --admin-enabled true
          echo "‚úÖ ACR admin user enabled!"

      # Verify ACR permissions
      - name: Verify ACR permissions
        run: |
          echo "üîê Verifying ACR permissions..."
          
          # Check if admin user is enabled
          ADMIN_ENABLED=$(az acr show \
            --name $AZURE_CONTAINER_REGISTRY \
            --query "adminUserEnabled" -o tsv)
          
          echo "ACR admin user enabled: $ADMIN_ENABLED"
          
          if [ "$ADMIN_ENABLED" != "true" ]; then
            echo "‚ùå ACR admin user not enabled - this will cause ImagePullFailure!"
            exit 1
          fi
          
          echo "‚úÖ ACR permissions verified"

      # Get ACR credentials
      - name: Get ACR credentials
        run: |
          echo "Getting ACR credentials..."
          ACR_USERNAME=$(az acr credential show --name $AZURE_CONTAINER_REGISTRY --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show --name $AZURE_CONTAINER_REGISTRY --query "passwords[0].value" -o tsv)
          echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_ENV
          echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_ENV
          echo "‚úÖ ACR credentials retrieved!"

      # Login to ACR
      - name: 'Login to ACR'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}

      # Build and Push Docker image
      - name: 'Build and Push Docker image'
        working-directory: .
        run: |
          docker build -f backend/Dockerfile -t $AZURE_CONTAINER_REGISTRY.azurecr.io/$IMAGE_NAME:${{ github.sha }} .
          docker tag $AZURE_CONTAINER_REGISTRY.azurecr.io/$IMAGE_NAME:${{ github.sha }} $AZURE_CONTAINER_REGISTRY.azurecr.io/$IMAGE_NAME:latest
          docker push $AZURE_CONTAINER_REGISTRY.azurecr.io/$IMAGE_NAME:${{ github.sha }}
          docker push $AZURE_CONTAINER_REGISTRY.azurecr.io/$IMAGE_NAME:latest

      # Verify image exists in ACR
      - name: Verify image in ACR
        run: |
          echo "üîç Verifying image exists in ACR..."
          
          # Check if latest tag exists
          if ! az acr repository show-tags \
            --name $AZURE_CONTAINER_REGISTRY \
            --repository $IMAGE_NAME \
            --query "[?contains(@, 'latest')]" -o tsv | grep -q "latest"; then
            echo "‚ùå Latest image not found in ACR!"
            exit 1
          fi
          
          # Check if commit image exists
          if ! az acr repository show-tags \
            --name $AZURE_CONTAINER_REGISTRY \
            --repository $IMAGE_NAME \
            --query "[?contains(@, '${{ github.sha }}')]" -o tsv | grep -q "${{ github.sha }}"; then
            echo "‚ùå Commit image not found in ACR!"
            exit 1
          fi
          
          echo "‚úÖ Images verified in ACR"

      # Check Azure CLI version and Web App type
      - name: Check Azure CLI and Web App type
        run: |
          echo "üîç Checking Azure CLI version and Web App type..."
          
          # Check Azure CLI version (fixed syntax)
          echo "Checking Azure CLI version..."
          az version
          
          # Check Web App type and configuration
          echo "Checking Web App config..."
          WEBAPP_CONFIG=$(az webapp config show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "{kind:kind,reserved:reserved,linuxFxVersion:linuxFxVersion}" \
            -o json)
          
          echo "Web App config: $WEBAPP_CONFIG"
          
          # Check if this is a Linux Web App
          WEBAPP_KIND=$(az webapp show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "kind" -o tsv)
          
          echo "Web App kind: $WEBAPP_KIND"
          
          if [[ "$WEBAPP_KIND" != *"linux"* ]]; then
            echo "‚ùå This is not a Linux Web App! Current kind: $WEBAPP_KIND"
            echo "‚ùå Container deployment requires a Linux Web App for Containers"
            exit 1
          fi
          
          echo "‚úÖ Web App type verified - Linux Web App detected"

      # Configure Web App for containers BEFORE deployment
      - name: Configure Web App for containers
        run: |
          echo "üîß Configuring Linux Web App for Containers BEFORE deployment"
          
          # Set container runtime for Linux Web App for Containers
          echo "Setting linux-fx-version..."
          LINUX_FX_RESULT=$(az webapp config set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --linux-fx-version "DOCKER|${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest" \
            2>&1)
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ linux-fx-version set successfully"
          else
            echo "‚ùå Failed to set linux-fx-version: $LINUX_FX_RESULT"
            exit 1
          fi
          
          # Set port configuration (Azure Web App standard)
          echo "Setting WEBSITES_PORT..."
          PORT_RESULT=$(az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --settings WEBSITES_PORT=8181 \
            2>&1)
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ WEBSITES_PORT set successfully"
          else
            echo "‚ùå Failed to set WEBSITES_PORT: $PORT_RESULT"
            exit 1
          fi
          
          # Set container registry credentials for Web App (using new Azure CLI syntax)
          echo "Setting container registry credentials..."
          CONTAINER_RESULT=$(az webapp config container set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --container-image-name "${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest" \
            --container-registry-url "https://${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io" \
            --container-registry-user "${{ env.ACR_USERNAME }}" \
            --container-registry-password "${{ env.ACR_PASSWORD }}" \
            2>&1)
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Container registry credentials set successfully with new syntax"
          else
            echo "‚ö†Ô∏è New syntax failed, trying deprecated syntax as fallback..."
            echo "Error with new syntax: $CONTAINER_RESULT"
            
            # Fallback to deprecated syntax
            CONTAINER_RESULT_FALLBACK=$(az webapp config container set \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --docker-custom-image-name "${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest" \
              --docker-registry-server-url "https://${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io" \
              --docker-registry-server-user "${{ env.ACR_USERNAME }}" \
              --docker-registry-server-password "${{ env.ACR_PASSWORD }}" \
              2>&1)
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Container registry credentials set successfully with deprecated syntax"
            else
              echo "‚ùå Both new and deprecated syntax failed: $CONTAINER_RESULT_FALLBACK"
              exit 1
            fi
          fi
          
          echo "‚úÖ Linux Web App for Containers configured with ACR authentication"

      # Verify container configuration BEFORE deployment
      - name: Verify container configuration
        run: |
          echo "üîç Verifying Linux Web App for Containers configuration..."
          
          # Check linux-fx-version (for Linux Web App for Containers)
          echo "Checking linux-fx-version..."
          LINUX_FX_VERSION=$(az webapp config show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "linuxFxVersion" -o tsv)
          
          echo "Linux FX Version: $LINUX_FX_VERSION"
          
          # Check container settings
          echo "Checking container config..."
          CONTAINER_CONFIG=$(az webapp config container show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "{image:containerImageName,registry:containerRegistryUrl,user:containerRegistryUser}" \
            -o json)
          
          echo "Container config: $CONTAINER_CONFIG"
          
          # Check individual container config values
          echo "Checking individual container config values..."
          
          # Try to get container image name from app settings (since we can see it there)
          echo "Checking container image name from app settings..."
          CONTAINER_IMAGE_FROM_SETTINGS=$(az webapp config appsettings list \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?name=='DOCKER_CUSTOM_IMAGE_NAME'].value" -o tsv)
          
          echo "Container Image Name from settings: '$CONTAINER_IMAGE_FROM_SETTINGS'"
          
          # Try new syntax first
          CONTAINER_IMAGE=$(az webapp config container show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "containerImageName" -o tsv)
          
          # If empty, try deprecated syntax
          if [ -z "$CONTAINER_IMAGE" ]; then
            echo "New syntax returned empty, trying deprecated syntax..."
            CONTAINER_IMAGE=$(az webapp config container show \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "dockerImageName" -o tsv)
          fi
          
          # If still empty, use the value from app settings
          if [ -z "$CONTAINER_IMAGE" ] && [ -n "$CONTAINER_IMAGE_FROM_SETTINGS" ]; then
            echo "Using container image name from app settings..."
            CONTAINER_IMAGE="$CONTAINER_IMAGE_FROM_SETTINGS"
          fi
          
          CONTAINER_REGISTRY=$(az webapp config container show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "containerRegistryUrl" -o tsv)
          
          # If empty, try deprecated syntax
          if [ -z "$CONTAINER_REGISTRY" ]; then
            echo "New syntax returned empty, trying deprecated syntax..."
            CONTAINER_REGISTRY=$(az webapp config container show \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "dockerRegistryServerUrl" -o tsv)
          fi
          
          # If still empty, use the value from app settings
          if [ -z "$CONTAINER_REGISTRY" ]; then
            echo "Using container registry URL from app settings..."
            CONTAINER_REGISTRY=$(az webapp config appsettings list \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "[?name=='DOCKER_REGISTRY_SERVER_URL'].value" -o tsv)
          fi
          
          CONTAINER_USER=$(az webapp config container show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "containerRegistryUser" -o tsv)
          
          # If empty, try deprecated syntax
          if [ -z "$CONTAINER_USER" ]; then
            echo "New syntax returned empty, trying deprecated syntax..."
            CONTAINER_USER=$(az webapp config container show \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "dockerRegistryServerUser" -o tsv)
          fi
          
          # If still empty, use the value from app settings
          if [ -z "$CONTAINER_USER" ]; then
            echo "Using container registry user from app settings..."
            CONTAINER_USER=$(az webapp config appsettings list \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "[?name=='DOCKER_REGISTRY_SERVER_USERNAME'].value" -o tsv)
          fi
          
          echo "Final Container Image Name: '$CONTAINER_IMAGE'"
          echo "Final Container Registry URL: '$CONTAINER_REGISTRY'"
          echo "Final Container Registry User: '$CONTAINER_USER'"
          
          # Check app settings
          echo "Checking WEBSITES_PORT..."
          PORT_SETTING=$(az webapp config appsettings list \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?name=='WEBSITES_PORT'].value" -o tsv)
          
          echo "WEBSITES_PORT setting: $PORT_SETTING"
          
          # Verify port is set correctly
          if [ "$PORT_SETTING" != "8181" ]; then
            echo "‚ö†Ô∏è Warning: WEBSITES_PORT is not set to 8181 (current: $PORT_SETTING)"
          fi
          
          echo "‚úÖ Linux Web App for Containers configuration verified"

      # Debug: Check current Web App configuration
      - name: Debug Web App configuration
        run: |
          echo "üîç Debug: Checking current Web App configuration..."
          
          # Show full Web App config
          echo "Full Web App config:"
          az webapp config show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --output table
          
          # Show container config specifically
          echo "Container config:"
          az webapp config container show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --output table
          
          # Show app settings
          echo "App settings:"
          az webapp config appsettings list \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --output table
          
          # Debug: Check what fields are actually available in container config
          echo "üîç Debug: Checking actual container config structure..."
          echo "Raw container config output:"
          az webapp config container show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --output json

      # Test container image pull from ACR (verify connectivity)
      - name: Test container image pull
        run: |
          echo "üß™ Testing if container image can be pulled from ACR..."
          
          # Try to pull the image locally to verify ACR connectivity
          if docker pull ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest; then
            echo "‚úÖ Container image pull test successful"
          else
            echo "‚ùå Container image pull test failed - ACR connectivity issue!"
            exit 1
          fi

      # Final verification - ensure Web App is ready for deployment
      - name: Final Web App verification
        run: |
          echo "üîç Final verification - ensuring Web App is ready for deployment..."
          
          # Check if Web App is in a good state
          echo "Checking Web App state..."
          WEBAPP_STATE=$(az webapp show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "state" -o tsv)
          
          echo "Web App state: $WEBAPP_STATE"
          
          # Check if container config is properly set
          echo "Checking container image configuration..."
          
          # Try new syntax first
          CONTAINER_READY=$(az webapp config container show \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "containerImageName" -o tsv)
          
          # If empty, try deprecated syntax
          if [ -z "$CONTAINER_READY" ]; then
            echo "New syntax returned empty, trying deprecated syntax..."
            CONTAINER_READY=$(az webapp config container show \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "dockerImageName" -o tsv)
          fi
          
          # If still empty, try to get from app settings
          if [ -z "$CONTAINER_READY" ]; then
            echo "Container config empty, trying app settings..."
            CONTAINER_READY=$(az webapp config appsettings list \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "[?name=='DOCKER_CUSTOM_IMAGE_NAME'].value" -o tsv)
          fi
          
          echo "Container image name: '$CONTAINER_READY'"
          echo "Expected image name: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest"
          
          if [ "$CONTAINER_READY" = "${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest" ]; then
            echo "‚úÖ Web App container configuration verified - ready for deployment!"
          else
            echo "‚ùå Web App container configuration not ready - deployment will fail!"
            echo "Debug: Expected vs Actual container image names don't match"
            exit 1
          fi

      # Deploy to Azure Web App (AFTER container config is set)
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: 'production'
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}

      # Wait for deployment
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          sleep 30

      # Resolve Web App hostname
      - name: Resolve Web App hostname
        id: resolve-host
        run: |
          HOSTNAME=$(az webapp show \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --name "${{ env.AZURE_WEBAPP_NAME }}" \
            --query defaultHostName -o tsv)
          echo "HOSTNAME=$HOSTNAME" >> $GITHUB_ENV
          echo "üîç Resolved host: $HOSTNAME"

      # Wait for /healthz to respond
      - name: Wait for /healthz
        shell: bash
        run: |
          echo "üè• Waiting for https://${HOSTNAME}/healthz"
          for i in {1..30}; do
            if curl -fsS --max-time 10 "https://${HOSTNAME}/healthz" > /dev/null; then
              echo "‚úÖ Healthy at https://${HOSTNAME}/healthz"
              exit 0
            fi
            echo "üîÑ Attempt $i/30 ‚Ä¶ not ready yet"; sleep 10
          done
          echo "‚ùå App never became healthy"; exit 1

      # Deployment success info
      - name: Deployment success info
        run: |
          echo "üéâ Backend deployed successfully!"
          echo "Image: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest"
          echo "Web App: https://${HOSTNAME}"
          echo "Health: https://${HOSTNAME}/healthz"
          echo "Runtime: Linux Web App for Containers with Node.js 20"
          echo "Port: 8181 (WEBSITES_PORT setting)"
          echo "Container Config: Linux FX Version with ACR authentication"
          echo "ACR: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io"
